name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via Bastion
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FASTAPI_PRIVATE_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          proxy_host: ${{ secrets.BASTION_IP }}
          proxy_username: ubuntu
          proxy_key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "1. Start Deployment"
            cd /home/ubuntu/fastapiBack1
            
            echo "2. Git Pull"
            git pull origin main
            
            echo "3. Update Dependencies"
            pip install -r requirements.txt
            
            echo "4. Restart FastAPI Service"
            sudo systemctl restart fastapi
            
            echo "5. Check Service Status"
            sudo systemctl is-active fastapi

